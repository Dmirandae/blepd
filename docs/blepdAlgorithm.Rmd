---
title: "Branch length evaluation for Phylogenetic Diversity"
author: "Daniel R. Miranda-Esquivel"
date: "today"
output: 
  pdf_document: 
    latex_engine: xelatex
---

# The Algorithm

##  Deconstructing the functions

First, we load the required libraries:

```{r}

## cleaning
rm(list = ls())

## libraries
library(ape)
library(vegan)
library(picante)

## installing and loading the package

##install.packages("../../blepd_0.1.1.tar.gz", repos = NULL, type="source")

library(blepd)

packageVersion("blepd")

## to plot trees 

library(ggtree)

library(gridExtra)

```

Now, we load the data: trees and distribution

```{r}

## trees

initialTree <- read.tree("../data/tree00")

## distributions

dist4taxa <- as.matrix(read.table("../data/dist4T00",
                                  stringsAsFactors=FALSE,
                                  header=TRUE,
                                  row.names=1)
                       )

## distribution to XY

distXY <-    matrix2XY(dist4taxa)

## plotting

## the tree

plotTree <-  ggtree(initialTree, ladderize=TRUE,
            color=c("black","black","black","black","black","black","black"), size=1 #, linetype="dotted"
            ) +  
            geom_tiplab(size=6, color="black") +
            # geom_nodepoint(color="#b5e521", alpha=1/4, size=c(0,15,10)) +
           theme_tree2() +  # geom_treescale() +
            labs(title = "A. Four terminals, equal branch length")

plotTree

## the distribution

plotDistrib <- ggplot(data=distXY, 
                       aes(x= Area, y= Terminal), 
                       size =11) +
               geom_point() +
               labs(title = "B. Terminals and Distributions",
                    y = "Terminal",
                    x = "Area")

plotDistrib

```

We check whether names in both objects, trees and distributions are the same:

```{r}

all(colnames(dist4taxa) == initialTree$tip.label)

```

We report all branches' length and calculate the PD values. 

```{r}

initialTree$edge.length

initialPD <- myPD(tree=initialTree, distribution = dist4taxa)
                                                                                                                        
```

## Single taxon evaluation function

We can test the effect of changing a single branch length:

we will:

1. create a copy of the initial branch length
2. calculate the initial PD and get the area(s) with the max value
2. change the length of a give terminal !!!(minus 9 and 11 in this example)
2. recalculate PD and get the area(s) with the max value
3. compare both areas to evaluate the effect of the perturbation

```{r}

initialLength <- initialTree$edge.length

bestInitialArea <- row.names(dist4taxa)[which(initialPD == max(initialPD))]

bestInitialArea

tipToEval <- "C"

value <- 2 

numberTipToEval <- which(initialTree$tip.label %in% tipToEval) 

newTree <- initialTree

newTree$edge.length[which(createTable(initialTree)[,2] %in% numberTipToEval)] <- value

newTree$edge.length

plotNewTree <- ggtree(newTree) + theme_tree2() +  
               geom_tiplab(size=6, color="black") +
               labs(title = "B. Four terminals, non equal branch length")

plotNewTree

### PD for th modified tree

modifiedPD <- myPD(tree = newTree, distribution = dist4taxa)

bestModifiedArea <- row.names(dist4taxa)[which(modifiedPD == max(modifiedPD))]

bestInitialArea

bestModifiedArea

bestInitialArea == bestModifiedArea

```

As shown, a modification in the branch lenght will impact the area selected, 
we can consider that the results are *very* sensible to chages in branch length.

## THE function

To evaluate the behaviour we cand modify a branch length, recalculate the 
PD value and compare the effect of this perturbation. We can turn this code 
into a function called evalTerminal, with four parameters:

1. a tree with branch length(s)
2. the distribution object
3. the terminal to evaluate
4. the approach to evaluate the terminal, that could be "lower",  or "upper" 
limits, to evaluate the minimal or the maximal value of the branch length 
where the PD value changes therefore another area is selected.  

```{r}

evalTerminal(tree = initialTree, distribution = dist4taxa, tipToEval = "A", approach = "lower" )

```

The lower limit when we change the brnach length for terminal A is 0.99, 
as any change in branch length will modify the area selected from AB to B, 
as the tie between the path between the terminals A/C vs B/D will be solved
in foavour of B/D when A is shorter.

```{r}

evalTerminal(tree = initialTree, distribution = dist4taxa, tipToEval = "B", approach = "lower" )

```

A similar result will arrive from changing terminal beranch B, but in 
this case the tie is solved to favour of A.

```{r}

evalTerminal(tree = initialTree, distribution = dist4taxa, tipToEval = "A", approach = "upper" )

```

And, the same result will arrive from changing the branch length of the 
terminal A from 1 and up, to find the upper limmit, the tie is solved in 
favour of B, opposite to the solution when we found the lower limit. 

In this case, even the smaller change in any terminal branch will modify the results.

We test the effect of the branch length for all terminals:

                                                                                                                                    FALTA LE CODIGO AQUI PARA ARBOL CON LOG IGUALES TODAS Y EMPATE, EL CASO
DISCUTIDO HASTA AHORA PERO EN UNA SOLA FUNCION

let's see  the effect ina tree with non equal branch lengths as the tree p
reviously modified

```{r}

newTree 

modifiedPD 

bestModifiedArea

evalTerminal(tree = newTree, distribution = dist4taxa, tipToEval = "C", approach = "upper" )

evalTerminal(tree = newTree, distribution = dist4taxa, tipToEval = "C", approach = "lower" )

```

The THING is the PD differenc between areas, and whether this value could be 
acumoulated in a single terminal branch or if the PD value is evnly distributed 
among all terminal branches and therefore to change the PD value more than one 
terminal must have to change ir order to get another value.
