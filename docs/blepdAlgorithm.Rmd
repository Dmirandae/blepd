---
title: "Branch length evaluation for Phylogenetic Diversity: the algorithm"
author: "Daniel R. Miranda-Esquivel"
date: "2018 - 01 - 16"
output: 
  pdf_document: 
    latex_engine: xelatex
---

# The Algorithm

##  Deconstructing the functions

First, we load the required libraries:

```{r}

## cleaning
rm(list = ls())

## libraries

## installing and loading the package

##install.packages("../../blepd_0.1.1.tar.gz", repos = NULL, type="source")

library(blepd)

packageVersion("blepd")

## to plot trees 

library(ggtree)

library(gridExtra)

```

Now, we load the data: trees and distribution

```{r}

## trees

initialTree <- read.tree("../testData/tree00")

initialTree

## distributions

dist4taxa <- as.matrix(read.table("../testData/dist4T00",
                                  stringsAsFactors=FALSE,
                                  header=TRUE,
                                  row.names=1)
                       )

## distribution to XY

distXY <- matrix2XY(dist4taxa)

## plotting

## the tree

plotTree <-  ggtree(initialTree, ladderize=TRUE,
             color="black", size=1 , linetype="dotted") +  
             geom_tiplab(size=6, color="black") +
             theme_tree2() +  
             labs(title = "A. Four terminals, equal branch length")

print(plotTree)

## the distribution

plotDistrib <- ggplot(data=distXY, 
                       aes(x= Area, y= Terminal), 
                       size =11) +
               geom_point() +
               labs(title = "B. Terminals and Distributions",
                    y = "Terminal",
                    x = "Area")

plotDistrib

```

We check whether names in both objects, trees and distributions are the same:

```{r}

all(colnames(dist4taxa) == initialTree$tip.label)

```

We report all branches' length and calculate the PD values. 

```{r}

initialTree$edge.length

initialPD <- myPD(tree=initialTree, distribution = dist4taxa)
                                                                                                                        
initialPD

```

## Single taxon evaluation function

To test the effect of changing a single terminal branch length, we will:

1. create a copy of the initial branch length.
2. calculate the initial PD and get the area(s) with the max value.
2. change the length of a give terminal: t1.
2. recalculate PD and get the area(s) with the max value.
3. compare both areas to evaluate the effect of the perturbation.

```{r}

initialLength <- initialTree$edge.length

bestInitialArea <- row.names(dist4taxa)[which(initialPD == max(initialPD))]

bestInitialArea

tipToEval <- "t1"

value <- 2 

numberTipToEval <- which(initialTree$tip.label %in% tipToEval) 

newTree <- initialTree

## a funtion to create a table binding tree$edge and tree$edge.length
createTable <- function(tree = tree){
                  allDataTable <- tree$edge
                  allDataTable <- cbind (allDataTable, tree$edge.length)
                  return(allDataTable)
                  }

newTree$edge.length[which(createTable(initialTree)[,2] %in% numberTipToEval)] <- value

newTree$edge.length

plotNewTree <- ggtree(newTree) + theme_tree2() +  
               geom_tiplab(size=6, color="black") +
               labs(title = "C. Four terminals, non equal branch length")

print(plotNewTree)

### PD for the modified tree

modifiedPD <- myPD(tree = newTree, distribution = dist4taxa)

bestModifiedArea <- row.names(dist4taxa)[which(modifiedPD == max(modifiedPD))]

bestInitialArea

bestModifiedArea

bestInitialArea == bestModifiedArea

```

As shown, a modification in the branch lenght will impact the area selected, 
we can consider that the results are *very* sensible to changes in branch length.

## THE function

To evaluate the behaviour we can modify a branch length, recalculate the 
PD value and compare the effect of this perturbation. We can turn this code 
into a function called evalTerminal, with four parameters:

1. a tree with branch lengths
2. the distribution object
3. the terminal to evaluate
4. the approach to evaluate the terminal, that could be "lower",  or "upper"  limits, to evaluate the minimal or the maximal value of the branch length where the PD value changes, therefore another area is selected.  

```{r}

evalTerminal(tree = initialTree, distribution = dist4taxa, tipToEval = "t1", approach = "lower" )

```

The lower limit when we change the brnach length for terminal A is 0.99, 
as any change in branch length will modify the area selected from A1A2 to A2, 
as the tie between the paths terminals A1/A3 vs A2/A4 will be solved
in favour of B/D when A1 is shorter.

```{r}

evalTerminal(tree = initialTree, distribution = dist4taxa, tipToEval = "t2", approach = "lower" )

```

A similar result will arrive from changing the terminal branch t2, but in 
this case the tie is solved to favour  A1.

```{r}

evalTerminal(tree = initialTree, distribution = dist4taxa, tipToEval = "t1", approach = "upper" )

```

And, the same result will arrive from changing the branch length of the 
terminal A from 1 and up, to find the upper limmit, the tie is solved in 
favour of B, opposite to the solution when we found the lower limit. 

In this case, even the smaller change in any terminal branch will modify the results.

We test the effect of the branch length for all terminals.

```{r}

newTree 

modifiedPD 

bestModifiedArea

evalTerminal(tree = newTree, distribution = dist4taxa, tipToEval = "t3", approach = "upper" )

evalTerminal(tree = newTree, distribution = dist4taxa, tipToEval = "t3", approach = "lower" )

```

The THING is the PD difference between areas, and whether this value could be 
accumulated in a single terminal branch or if the PD value is evenly distributed 
among all terminal branches and therefore to change the PD value more than one 
terminal must have to change in order to get another value.

The function to test all terminals at the same time is evalTree, with two parameters: the tree and the distribution. The function returns a data.frame object with 14 fields: labelTerminal, lowerBranchLength, InitialArea, lowerFinalArea, initialLength, upperBranchLength, upperFinalArea, changeLower, changeUpper, deltaUpper, deltaLower, deltaPD, areaDelta, and abDelta.


```{r}

evalTree(tree = initialTree, distribution = dist4taxa)

```


The column abDelta shows that any change  -larger than 0- in the branch length will change the area selected, showing the sensitivity of the PD results to the terminal branch lengths. 