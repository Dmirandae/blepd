---
title: "An empirical example: _Rhynoclemmys_ data."
author: "Daniel R. Miranda-Esquivel"
date: "2020 - 10 - 18"
output:
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
bibliography: "/home/rafael/disco2/uis/proyectosDRME/indices/mainPaper/bib/blepd.bib"
---




We read the data, distribution and tree.



```{r eval=TRUE, echo=TRUE}

## for reproductibility purposes

set.seed(121)


options(warn=-1)
suppressMessages(library(ggtree))
#~ library(ape)
suppressMessages(library(blepd))
library(ggplot2)
#~ library(ggtree)


## Version

cat("Analyses made  with blepd version:",unlist(packageVersion("blepd")))



## Create an object to place the distribution and the tree


RhinoclemmysData <- list()


## Read data

## distribution is a csv file areas x terminals, labeled


setwd("../data/")

csvFile <- dir(pattern=".csv")

RhinoclemmysData$distribution <-  as.matrix(read.table(csvFile,
                                  stringsAsFactors=TRUE,
                                  header=TRUE,
                                  row.names=1,
                                  sep=",")
                          )


##print(t(RhinoclemmysData$distribution))



## tree(s) in nexus or newick format

treeFiles <- dir(pattern=".tre")

##treeFiles


RhinoclemmysData$tree  <-    read.tree(treeFiles)


## name of tree(s)

treeFiles <- gsub(".tre","",treeFiles)





## Plotting


#par(mfrow=c(2,1))


## The tree

## using ggtree

plotTree <-  ggtree(RhinoclemmysData$tree, ladderize=TRUE,
                    color="black", size=0.51, linetype="solid") +
             geom_tiplab(size=4, color="black") +
             xlim(0,0.035) +
             theme_tree2() +
             ggtitle(treeFiles[1])



##print(plotTree)


#~ Alternatively, we can plot the trees using  APE
##
## plot.phylo(RhinoclemmysData$tree)
##
####nodelabels()
####tiplabels()




## the distribution


distXY <- matrix2XY(RhinoclemmysData$distribution)


terminals <- colnames(RhinoclemmysData$distribution)


realOrder <- match(terminals,RhinoclemmysData$tree$tip.label)


equivalencias <- data.frame(terminals,realOrder)


dXY2 <-     distXY

for(cambiar in terminals){

    dXY2$Terminal[distXY$Terminal == cambiar]     <-
    equivalencias$realOrder[equivalencias$terminals==cambiar]

}


distGraficar <- dXY2

plotDistrib <- ggplot(distGraficar,
                      aes(x= Area, y=Terminal), size =35) +
               geom_point(shape=19, fill="white", color="darkred", size=7) +
               labs(title = "Distributions",
                    y = "",
                    x = "Area") +
               theme(axis.line=element_blank(),
					 axis.text.y=element_blank(), 
					 axis.ticks=element_blank(), 
					 axis.title.y=element_blank(), 
					 legend.position="none", 
					 panel.background=element_blank(), 
					 panel.border=element_blank(), 
					 panel.grid.major=element_blank(), 
					 panel.grid.minor=element_blank(), 
					 plot.background=element_blank()
					 ) 


##print(plotDistrib)

##
cowplot::plot_grid(plotTree, plotDistrib, ncol=2)


##dev.off()

```

We want to test whether the branch lengths will have any effect in the
area(s) chosen for conservation using a Phylogenetic Diversity (PD)
analysis.

The topology corresponds to a Total Evidence analysis for the
_Rhynoclemmys_ genus, from @alarcon2020a, and the distribution is
taken and modified from @le2008.




```{r eval=TRUE, echo=TRUE}

#par(mfrow=c(2,1))


#par(mfrow=c(2,1))

a  <- qplot(RhinoclemmysData$tree$edge.length,
            bins=12,
            main=treeFiles,
            xlab="Branch length: internals and terminals") +
            xlim(c(0.001,0.025)) +
            ylim(c(0,5))


terminals <- RhinoclemmysData$tree$edge[,2] < 1+length(RhinoclemmysData$tree$tip.label)


b  <- qplot(RhinoclemmysData$tree$edge.length[terminals],
            bins=12,
            #main=treeFiles,
            xlab="Branch length: terminals")  +
            xlim(c(0.001,0.025)) +
            ylim(c(0,5))


c  <- qplot(RhinoclemmysData$tree$edge.length[!terminals],
            bins=12,
            #main=treeFiles,
            xlab="Branch length: internals")  +
            xlim(c(0.001,0.025)) +
            ylim(c(0,5))


#~ 

cowplot::plot_grid(a, b, c, nrow=3)

###dev.off()

```

The branch length histogram and the tree plot, show the internal length 
branches are similar, nad different to terminals'; there are two longer 
branches, _R._ _aerolata_ (inhabiting Al) and _R._ _rubida_ (Pl), while 
Al and Cho are the richest areas.



Fist we calculate the PD value for the tree, we save the values as a
table and later we convert the table to a matrix.


```{r eval=TRUE, echo=TRUE}


RhinoclemmysData$tablePD <- PDindex(RhinoclemmysData$tree,
                                    distribution=RhinoclemmysData$distribution,
                                    root=TRUE)



RhinoclemmysData$matrixPD <- as.data.frame(
                                  matrix(
                                      unlist(RhinoclemmysData$tablePD),
                                      nrow= length(treeFiles),
                                      byrow=TRUE))



colnames(RhinoclemmysData$matrixPD) <- row.names(RhinoclemmysData$distribution)

row.names(RhinoclemmysData$matrixPD) <- "PD value"

print(t(sort(RhinoclemmysData$matrixPD,decreasing = TRUE)))

```

Now, we test the efect of branch length swapping, terminal and internal branch lengths.


```{r eval=TRUE, echo=TRUE}


 for( modelo in c("simpleswap","allswap","uniform") ){

        for( rama in c("terminals","internals") ){

            val <- swapBL(RhinoclemmysData$tree,
                          RhinoclemmysData$distribution,
                          model = modelo,
                         branch = rama
               )

         cat("\n\tTree=",treeFiles,"\n\tModel=",modelo,"\n\tBranchs swapped=",rama,"\n")

        print.blepd(val)

         cat("\n\n\n")

     }

  }

```


The terminal branch length is critical in the decision taken, if we
swap all terminal branch lengths (model=_allswap_), or if we replace
them with a uniform distribution (model=_uniform_), the area selected
might change from Cho to Al. As the terminal branch lengths are distributed
unequally, we might suspect that the results depend heavily on the
longest branches that inhabit the area.

But first, let us see if the number of replicates has any effect.

```{r eval=TRUE, echo=TRUE}

for(repetir in 1:3){

            val <- swapBL(RhinoclemmysData$tree,
                          RhinoclemmysData$distribution,
                          model = "allswap",
                         branch = "terminals",
                         nTimes = 10**repetir
                         )
                         
            print.blepd(val)

}
```

Roughly speaking from 1000 -- 10000 the results are alike, and the
largest difference is in 10 --100. As a rule of thumb, we most use at
least 100 replicates, but 1000 will be better.



now, let's see if the possible difference in results could be assigned to both of our longest branches.

```{r eval=TRUE, echo=TRUE}
## Testing the effect if we reduce the branch lenght form the actual
## value to 0.0 using evalTerminal {lower}

testEvalTerminalALL <- evalTerminal(RhinoclemmysData$tree,
                                    RhinoclemmysData$distribution,
                                    tipToEval = "all",
                                    approach = "lower")


print.multiBlepd(testEvalTerminalALL)


## Testing the effect if we increase the branch lenght form the actual
## value to the sum of all branch length using evalTerminal {upper}


testEvalTerminalALL <- evalTerminal(RhinoclemmysData$tree,
                                    RhinoclemmysData$distribution,
                                    tipToEval = "all",
                                    approach = "upper")

print.multiBlepd(testEvalTerminalALL)

```


The area selected depends heavily in the branch length of _R._ _aerolata_ and _R._ _rubida_, if the branch length is just a little shorter, the area selected will change from area A to area B.


To test whether internal branches have more impact than terminal branches, we can use the function evalTerminalvsInternal.


```{r eval=TRUE, echo=TRUE}


#~  ## calculate values

terminals  <- evalTerminalvsInternal(RhinoclemmysData$tree,
                                RhinoclemmysData$distribution,
                                nTimes=100,
                                branch = "terminals")

internals  <- evalTerminalvsInternal(RhinoclemmysData$tree,
                                RhinoclemmysData$distribution,
                                nTimes=100,
                                branch = "internals")


for( i in 1:3 ){

#    cat("name ",i,"\n")


    cat("Evaluated:",terminals[[i]]$evaluated,"\tBranch swapped:",terminals[[i]]$branch,"\n")

    print.blepd(terminals[[i]])

    cat("Evaluated:",internals[[i]]$evaluated,"\tBranch swapped:",internals[[i]]$branch,"\n")

    print.blepd(internals[[i]])

}






```
