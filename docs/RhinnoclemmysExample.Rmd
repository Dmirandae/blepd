---
title: "An empirical example: _Rhynoclemmys_ data."
author: "Daniel R. Miranda-Esquivel"
date: "2020 - 10 - 15"
output:
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
---


# An empirical example: _Rhynoclemmys_ data.

We read the data, distribution and tree.


```{r}

options(warn=-1)
suppressMessages(library(ggtree))
#~ library(ape)
suppressMessages(library(blepd))
library(ggplot2)
#~ library(ggtree)



## read distributional data

setwd("../data/")

csvFile <- dir(pattern=".csv")


distribution <-          as.matrix(read.table(csvFile,
                                  stringsAsFactors=FALSE,
                                  header=TRUE,
                                  row.names=1,
                                  sep=",")
                          )

##qplot(distribution)



## read trees

treeFiles <- dir(pattern=".tre")

treeFiles

## both things in a single object


RhinoclemmysData <- list()

RhinoclemmysData$distribution <- distribution

distXY <- matrix2XY(distribution)



RhinoclemmysData$tree  <-    read.tree(treeFiles)

treeFiles <- gsub(".tre","",treeFiles)


## plotting  the tree


## using ggtree

par(mfrow=c(1,2))


plotTree <-  ggtree(RhinoclemmysData$tree, ladderize=TRUE,
                    color="black", size=1, linetype="solid") +
             geom_tiplab(size=4, color="black") +
             theme_tree2() +
             ggtitle(treeFiles[1])


##print(plotTree)


#~ Alternatively, we can plot the trees using  APE
##
## plot.phylo(RhinoclemmysData$tree)
##




## the distribution

plotDistrib <-ggplot(distXY,
               aes(x= Area, y=Terminal), size =11) +
              geom_point() +
               labs(title = "Distributions",
                    y = "",
                    x = "Area")

##print(plotDistrib)

##
cowplot::plot_grid(plotTree, plotDistrib, ncol=2)

# Using faceplot
#~ p2 <- facet_plot(plotTree, panel="dot",
#~                  data=distXY,
#~                  geom=geom_point(),
#~                  mapping=aes(x= distXY$Area,y=distXY$Terminal),
#~                  size =11, color='red3')


#~ print(p2)

##dev.off()

```


The tree corresponds to a TotalEvidence analysis for the _Rhynoclemmys_ genus, and we want to test whether the branch lengths  will have any effect in the areas chosen.





```{r}

par(mfrow=c(2,1))

qplot(RhinoclemmysData$tree$edge.length,
      bins=10,
      main=treeFiles,
      xlab="Branch length")

###dev.off()

```

The branch length histogram shows there are two longer branches,  _R._ _aerolata_ and _R._ _rubida_ and these two are in area A, while area B is the richest.




Fist we calculate the PD value for the tree, we save the values as a table and later we convert the table to a matrix:

```{r}


RhinoclemmysData$tablePD <- PDindex(RhinoclemmysData$tree,
                                   distribution=RhinoclemmysData$distribution,
                                   root=TRUE)



RhinoclemmysData$matrixPD <- as.data.frame(
                                  matrix(
                                      unlist(RhinoclemmysData$tablePD),
                                      nrow= length(treeFiles),
                                      byrow=TRUE))




```

Now, we test the efect of branch length swapping, terminal and internal branch lengths.


```{r}


 for( modelo in c("simpleswap","allswap","uniform") ){

        for( rama in c("terminals","internals") ){

        val <- swapBL(RhinoclemmysData$tree,distribution,
               model=modelo,
               branch = rama
               )

         cat("\nTree=",treeFiles,"\tModel=",modelo,"\tBranchs swapped=",rama,"\n")

        t5 <- print.blepd(val)


         cat("\n\n\n")

     }


  }







```

For both trees, the terminal branch length is critical in the decision taken, if we swap all terminal branch lengths (model=_allswap_), or if we replace them with a uniform distribution (model=_uniform_), the area selected changes from A to B.

As the terminal branch lengths are distributed unequally, we might suspect that the results depend heavily on the longest branches that inhabit the area A.


```{r}


## Testing the effect if we reduce the branch lenght form the actual value to 0.0 using evalTerminal {lower}

testEvalTerminalALL <- evalTerminal(RhinoclemmysData$tree,distribution,tipToEval = "all",approach = "lower")

print.multiBlepd(testEvalTerminalALL)


## Testing the effect if we increase the branch lenght form the actual value to the sum of all branch length  using evalTerminal {upper}


testEvalTerminalALL <- evalTerminal(RhinoclemmysData$tree,distribution,tipToEval = "all",approach = "upper")

print.multiBlepd(testEvalTerminalALL)


```




The area selected depends heavily in the branch length of _R._ _aerolata_ and _R._ _rubida_, if the branch length is just a little shorter, the area selected will change from area A to area B.


To test whether internal branches have more impact than terminal branches, we can use the function evalTerminalvsInternal.


```{r}


#~  ## calculate values

data1 <- evalTerminalvsInternal(RhinoclemmysData$tree,distribution,nTimes=100,branch = "terminals")
data2 <- evalTerminalvsInternal(RhinoclemmysData$tree,distribution,nTimes=100,branch = "internals")



for( i in 1:3 ){

    cat("name ",i,"\n")
    print.blepd(data1[[i]])
    print.blepd(data2[[i]])

}




```
