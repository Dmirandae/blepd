---
title: "An empirical example: _Rhynoclemmys_ data."
author: "Daniel R. Miranda-Esquivel"
date: "2020 - 10 - 15"
output:
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
bibliography: "/home/rafael/disco2/uis/proyectosDRME/indices/mainPaper/bib/blepd.bib"
---



# An empirical example: _Rhynoclemmys_ data.

We read the data, distribution and tree.
bibliography:/home/rafael/disco2/uis/proyectosDRME/indices/mainPaper/bib/todo.bibtex


```{r eval=TRUE, echo=FALSE}


options(warn=-1)
suppressMessages(library(ggtree))
#~ library(ape)
suppressMessages(library(blepd))
library(ggplot2)
#~ library(ggtree)


## Version

print(packageVersion("blepd"))



## Create an object to place the distribution and the tree


RhinoclemmysData <- list()


## Read data

## distribution is a csv file areas x terminals, labeled


setwd("../data/")

csvFile <- dir(pattern=".csv")

RhinoclemmysData$distribution <-  as.matrix(read.table(csvFile,
                                  stringsAsFactors=FALSE,
                                  header=TRUE,
                                  row.names=1,
                                  sep=",")
                          )


print(t(RhinoclemmysData$distribution))



## tree(s) in nexus or newick format

treeFiles <- dir(pattern=".tre")

treeFiles


RhinoclemmysData$tree  <-    read.tree(treeFiles)


## name of tree(s)

treeFiles <- gsub(".tre","",treeFiles)





## Plotting


#par(mfrow=c(2,1))


## The tree

## using ggtree

plotTree <-  ggtree(RhinoclemmysData$tree, ladderize=FALSE,
                    color="black", size=0.51, linetype="solid") +
                     geom_tiplab(size=4, color="black") +
                     xlim(0,0.035) +
##            theme_tree2() +
            theme_tree2() +
             ggtitle(treeFiles[1])



##print(plotTree)


#~ Alternatively, we can plot the trees using  APE
##
## plot.phylo(RhinoclemmysData$tree)
##
####nodelabels()
####tiplabels()




## the distribution


distXY <- matrix2XY(RhinoclemmysData$distribution)


terminals <- colnames(RhinoclemmysData$distribution)


realOrder <- match(terminals,RhinoclemmysData$tree$tip.label)


equivalencias <- data.frame(terminals,realOrder)


dXY2 <-     distXY

for(cambiar in terminals){

    dXY2$Terminal[distXY$Terminal == cambiar]     <-
    equivalencias$realOrder[equivalencias$terminals==cambiar]

}


distGraficar <- dXY2

plotDistrib <- ggplot(distGraficar,
                      aes(x= Area, y=Terminal), size =35) +
               geom_point(shape=19, fill="white", color="darkred", size=5) +
               labs(title = "Distributions",
                    y = "",
                    x = "Area") +
          theme(axis.line=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          panel.background=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.background=element_blank())



##print(plotDistrib)

##
cowplot::plot_grid(plotTree, plotDistrib, ncol=2)

# Using faceplot
#~ p2 <- facet_plot(plotTree, panel="dot",
#~                  data=distXY,
#~                  geom=geom_point(),
#~                  mapping=aes(x= distXY$Area,y=distXY$Terminal),
#~                  size =11, color='red3')


#~ print(p2)

##dev.off()

```

The tree corresponds to a Total Evidence analysis for the _Rhynoclemmys_ genus,
the topology from [@alarcon2020a], and the distribution from [@le2008]
and we want to test whether the branch lengths will have any effect in the areas chosen using a Pylgenetic Diversity (PD) analysis.





```{r eval=TRUE, echo=FALSE}

par(mfrow=c(2,1))

qplot(RhinoclemmysData$tree$edge.length,
      bins=10,
      main=treeFiles,
      xlab="Branch length")

###dev.off()

```

The branch length histogram shows there are two longer branches,  _R._ _aerolata_ and _R._ _rubida_ and these two are located in area A, while area B is the richest.




Fist we calculate the PD value for the tree, we save the values as a table and later we convert the table to a matrix:

```{r eval=TRUE, echo=FALSE}


RhinoclemmysData$tablePD <- PDindex(RhinoclemmysData$tree,
                                    distribution=RhinoclemmysData$distribution,
                                    root=TRUE)



RhinoclemmysData$matrixPD <- as.data.frame(
                                  matrix(
                                      unlist(RhinoclemmysData$tablePD),
                                      nrow= length(treeFiles),
                                      byrow=TRUE))




```

Now, we test the efect of branch length swapping, terminal and internal branch lengths.


```{r eval=TRUE, echo=FALSE}


 for( modelo in c("simpleswap","allswap","uniform") ){

        for( rama in c("terminals","internals") ){

            val <- swapBL(RhinoclemmysData$tree,
                          RhinoclemmysData$distribution,
                          model = modelo,
                         branch = rama
               )

         cat("\nTree=",treeFiles,"\tModel=",modelo,"\tBranchs swapped=",rama,"\n")

        print.blepd(val)

         cat("\n\n\n")

     }

  }

```

Rhe terminal branch length is critical in the decision taken, if we swap all terminal branch lengths (model=_allswap_), or if we replace them with a uniform distribution (model=_uniform_), the area selected changes from A to B. As the terminal branch lengths are distributed unequally, we might suspect that the results depend heavily on the longest branches that inhabit the area A.


```{r eval=TRUE, echo=FALSE}


## Testing the effect if we reduce the branch lenght form the actual value to 0.0 using evalTerminal {lower}

testEvalTerminalALL <- evalTerminal(RhinoclemmysData$tree,
                                    RhinoclemmysData$distribution,
                                    tipToEval = "all",
                                    approach = "lower")


print.multiBlepd(testEvalTerminalALL)


## Testing the effect if we increase the branch lenght form the actual value to the sum of all branch length  using evalTerminal {upper}


testEvalTerminalALL <- evalTerminal(RhinoclemmysData$tree,
                                    RhinoclemmysData$distribution,
                                    tipToEval = "all",
                                    approach = "upper")

print.multiBlepd(testEvalTerminalALL)


```


The area selected depends heavily in the branch length of _R._ _aerolata_ and _R._ _rubida_, if the branch length is just a little shorter, the area selected will change from area A to area B.


To test whether internal branches have more impact than terminal branches, we can use the function evalTerminalvsInternal.


```{r eval=TRUE, echo=FALSE}


#~  ## calculate values

terminals  <- evalTerminalvsInternal(RhinoclemmysData$tree,
                                RhinoclemmysData$distribution,
                                nTimes=100,
                                branch = "terminals")

internals  <- evalTerminalvsInternal(RhinoclemmysData$tree,
                                RhinoclemmysData$distribution,
                                nTimes=100,
                                branch = "internals")


for( i in 1:3 ){

#    cat("name ",i,"\n")


    cat("Evaluated:",terminals[[i]]$evaluated,"\tBranch swapped:",terminals[[i]]$branch,"\n")

    print.blepd(terminals[[i]])

    cat("Evaluated:",internals[[i]]$evaluated,"\tBranch swapped:",internals[[i]]$branch,"\n")

    print.blepd(internals[[i]])

}



```
